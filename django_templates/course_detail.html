{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ course.name }} - Yosh Tadqiqotchi{% endblock %}

{% block content %}
<section class="subpage-hero stipendiya-hero">
    <div class="subpage-hero-inner">
        <div class="subpage-hero-text">
            <div class="subpage-breadcrumb">
                <a href="{% url 'main:home' %}">Bosh sahifa</a>
                <span>//</span>
                <a href="{% url 'main:courses' %}">Kurslar</a>
                <span>//</span>
                <span>{{ course.name }}</span>
            </div>
            <h1 class="title subpage-title">{{ course.name }}</h1>
            <p class="subtitle subpage-subtitle">{{ course.short_description }}</p>
            
            <div style="display: flex; gap: 24px; margin-top: 20px; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-book" style="color: #3b82f6; font-size: 20px;"></i>
                    <span style="color: #6b7280; font-weight: 500;">{{ course.module_count }} ta modul</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-clock" style="color: #10b981; font-size: 20px;"></i>
                    <span style="color: #6b7280; font-weight: 500;">{{ course.time_per_question }} daqiqa/savol</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-trophy" style="color: #f59e0b; font-size: 20px;"></i>
                    <span style="color: #6b7280; font-weight: 500;">O'tish: {{ course.passing_score }}%</span>
                </div>
            </div>
        </div>
        {% if course.image %}
        <div class="subpage-hero-illustration">
            <div class="subpage-hero-image-wrapper">
                <img src="{{ course.image.url }}" alt="{{ course.name }}" class="subpage-hero-image" />
            </div>
        </div>
        {% endif %}
    </div>
</section>

<section class="stipendiya-table-section">
    <div class="stipendiya-container">
        <div class="card stipendiya-table-card">
            <div class="stipendiya-table-header">
                <h2 class="subtitle">Kurs modullari</h2>
                <p class="text-muted">Modullarni ketma-ket o'rganing. Har bir modulni tugatsangiz, keyingisi ochiladi.</p>
            </div>
            
            {% if modules %}
                <div style="display: flex; flex-direction: column; gap: 40px; padding: 24px;">
                    {% for module in modules %}
                    <div class="module-section" style="border: 3px solid {% if module.is_completed %}#10b981{% elif module.is_unlocked %}#3b82f6{% else %}#e5e7eb{% endif %}; border-radius: 16px; overflow: hidden; background: white; position: relative;">
                        <!-- Module Header -->
                        <div style="background: {% if module.is_completed %}#10b981{% elif module.is_unlocked %}#3b82f6{% else %}#9ca3af{% endif %}; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="display: inline-flex; align-items: center; justify-content: center; width: 45px; height: 45px; border-radius: 50%; background: white; color: {% if module.is_completed %}#10b981{% elif module.is_unlocked %}#3b82f6{% else %}#9ca3af{% endif %}; font-weight: bold; font-size: 20px;">
                                    {{ module.number }}
                                </span>
                                <h3 style="margin: 0; font-size: 22px; font-weight: 700; color: white;">{{ module.name }}</h3>
                            </div>
                            {% if module.is_completed %}
                            <span style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: white; color: #10b981; border-radius: 8px; font-size: 15px; font-weight: 600;">
                                <i class="fas fa-check-circle"></i> Tugatilgan
                            </span>
                            {% elif not module.is_unlocked %}
                            <span style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: rgba(255,255,255,0.3); color: white; border-radius: 8px; font-size: 15px; font-weight: 600;">
                                <i class="fas fa-lock"></i> Yopiq
                            </span>
                            {% endif %}
                        </div>
                        
                        {% if module.is_unlocked %}
                        <!-- Module Content: Left-Right Layout -->
                        <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 0; min-height: 400px;">
                            <!-- Left Side: Description & Presentation -->
                            <div style="padding: 32px; background: #f9fafb; border-right: 2px solid #e5e7eb;">
                                <h4 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #111827;">
                                    <i class="fas fa-info-circle" style="color: #3b82f6;"></i> Modul haqida
                                </h4>
                                <p style="margin: 0 0 24px 0; color: #4b5563; line-height: 1.8; font-size: 15px;">
                                    {{ module.description|default:"Ushbu modulda muhim mavzular o'rganiladi." }}
                                </p>
                                
                                {% if module.presentation %}
                                <div style="margin-top: auto; padding-top: 24px;">
                                    <a href="{{ module.presentation.url }}" 
                                       download 
                                       class="btn-gradient presentation-download" 
                                       data-module-id="{{ module.id }}"
                                       style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 14px 20px; text-decoration: none; border-radius: 10px; font-weight: 600; font-size: 15px; width: 100%; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                                        <i class="fas fa-file-powerpoint" style="font-size: 18px;"></i>
                                        <span>Taqdimotni yuklash</span>
                                    </a>
                                </div>
                                {% endif %}
                                
                                <!-- Progress Indicators -->
                                <div style="margin-top: 24px; padding: 16px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <div style="font-size: 14px; font-weight: 600; color: #6b7280; margin-bottom: 12px;">Bajarilish holati:</div>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <i class="fas fa-{% if module.progress and module.progress.watched_video %}check-circle{% else %}circle{% endif %} video-status-{{ module.id }}" style="color: {% if module.progress and module.progress.watched_video %}#10b981{% else %}#d1d5db{% endif %}; font-size: 16px;"></i>
                                            <span style="color: #4b5563; font-size: 14px;">Video ko'rildi</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <i class="fas fa-{% if module.progress and module.progress.viewed_presentation %}check-circle{% else %}circle{% endif %} presentation-status-{{ module.id }}" style="color: {% if module.progress and module.progress.viewed_presentation %}#10b981{% else %}#d1d5db{% endif %}; font-size: 16px;"></i>
                                            <span style="color: #4b5563; font-size: 14px;">Taqdimot yuklandi</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Complete Module Button -->
                                    {% if not module.is_completed %}
                                    <div class="complete-btn-container-{{ module.id }}" style="margin-top: 16px;">
                                        <button class="complete-module-btn" 
                                                data-module-id="{{ module.id }}"
                                                data-video-done="{% if module.progress and module.progress.watched_video %}true{% else %}false{% endif %}"
                                                data-presentation-done="{% if module.progress and module.progress.viewed_presentation %}true{% else %}false{% endif %}"
                                                style="width: 100%; padding: 12px 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); transition: all 0.3s; {% if not module.progress or not module.progress.watched_video or not module.progress.viewed_presentation %}opacity: 0.4; pointer-events: none;{% endif %}">
                                            <i class="fas fa-check-double"></i>
                                            <span>O'rgandim</span>
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Right Side: Embedded YouTube Video -->
                            <div style="padding: 32px; background: white; display: flex; flex-direction: column;">
                                {% if module.youtube_url %}
                                    <h4 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #111827;">
                                        <i class="fab fa-youtube" style="color: #ff0000;"></i> Video dars
                                    </h4>
                                    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12);">
                                        <iframe 
                                            src="{{ module.youtube_url|youtube_embed_url }}&enablejsapi=1" 
                                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;"
                                            allowfullscreen
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                            class="youtube-video"
                                            data-module-id="{{ module.id }}"
                                            id="video-{{ module.id }}"
                                        ></iframe>
                                    </div>
                                    <p style="margin-top: 16px; color: #6b7280; font-size: 14px; text-align: center;">
                                        <i class="fas fa-info-circle"></i> Videoni korib chiqing va sahhifani qayta yuklang, so'ngra "O'rgandim" tugmasini bosing
                                    </p>
                                {% else %}
                                    <div style="flex: 1; display: flex; align-items: center; justify-content: center; background: #f3f4f6; border-radius: 12px; border: 2px dashed #d1d5db;">
                                        <div style="text-align: center;">
                                            <i class="fas fa-video-slash" style="font-size: 48px; color: #9ca3af; margin-bottom: 12px;"></i>
                                            <p style="color: #6b7280; margin: 0;">Video dars hozircha yuklanmagan</p>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <!-- Locked Module Content -->
                        <div style="padding: 48px; text-align: center; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);">
                            <i class="fas fa-lock" style="font-size: 64px; color: #9ca3af; margin-bottom: 16px;"></i>
                            <h4 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 600; color: #6b7280;">Modul yopiq</h4>
                            <p style="margin: 0; color: #9ca3af; font-size: 15px;">Avvalgi modulni tugatib, ushbu modulni oching</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Test Section -->
                {% if all_modules_completed %}
                    {% if test_passed %}
                    <!-- Test passed - show certificate and retry button -->
                    <div style="padding: 32px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 16px; margin: 24px; text-align: center; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);">
                        <i class="fas fa-award" style="font-size: 72px; color: white; margin-bottom: 16px;"></i>
                        <h3 style="color: white; margin: 0 0 12px 0; font-size: 28px; font-weight: 700;">
                            Tabriklaymiz!
                        </h3>
                        <p style="color: rgba(255,255,255,0.95); font-size: 18px; margin: 0 0 24px 0;">
                            Siz kursni muvaffaqiyatli yakunladingiz! Natija: {{ course_progress.test_score }}%
                        </p>
                        
                        <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                            {% if certificate %}
                            <a href="{% url 'main:download_certificate' certificate.id %}" class="btn-gradient" style="display: inline-flex; align-items: center; gap: 10px; padding: 16px 32px; background: white; color: #10b981; text-decoration: none; border-radius: 10px; font-weight: 700; font-size: 17px; box-shadow: 0 6px 20px rgba(0,0,0,0.15);">
                                <i class="fas fa-download" style="font-size: 20px;"></i>
                                <span>Sertifikatni yuklash</span>
                            </a>
                            {% endif %}
                            <a href="{% url 'main:course_test' course.id %}" class="btn-gradient" style="display: inline-flex; align-items: center; gap: 10px; padding: 16px 32px; background: rgba(255,255,255,0.2); color: white; text-decoration: none; border-radius: 10px; font-weight: 700; font-size: 17px; border: 2px solid white;">
                                <i class="fas fa-redo" style="font-size: 20px;"></i>
                                <span>Takrorlash</span>
                            </a>
                        </div>
                    </div>
                    {% else %}
                    <!-- Test not passed - show retry button with timer -->
                    <div style="padding: 32px; background: linear-gradient(135deg, #8b5cf6 0%, #d946ef 100%); border-radius: 16px; margin: 24px; text-align: center; box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3);">
                        {% if last_test %}
                            {% if can_retry %}
                                <!-- Can retry now -->
                                <i class="fas fa-trophy" style="font-size: 72px; color: white; margin-bottom: 16px;"></i>
                                <h3 style="color: white; margin: 0 0 12px 0; font-size: 28px; font-weight: 700;">
                                    Testni qayta topshiring
                                </h3>
                                <p style="color: rgba(255,255,255,0.95); margin: 0 0 8px 0; font-size: 17px;">
                                    Oxirgi natija: {{ last_test.percentage }}% (O'tish bali: {{ course.passing_score }}%)
                                </p>
                                <p style="color: rgba(255,255,255,0.85); margin: 0 0 24px 0; font-size: 15px;">
                                    Testni ixtiyoriy takrorlashingiz mumkin
                                </p>
                                <a href="{% url 'main:course_test' course.id %}" class="btn-gradient" style="display: inline-flex; align-items: center; gap: 10px; padding: 16px 40px; background: white; color: #667eea; text-decoration: none; border-radius: 10px; font-weight: 700; font-size: 17px; box-shadow: 0 6px 20px rgba(0,0,0,0.15);">
                                    <i class="fas fa-redo" style="font-size: 20px;"></i>
                                    <span>Qayta boshlash</span>
                                </a>
                            {% else %}
                                <!-- Waiting period -->
                                <i class="fas fa-clock" style="font-size: 72px; color: white; margin-bottom: 16px;"></i>
                                <h3 style="color: white; margin: 0 0 12px 0; font-size: 28px; font-weight: 700;">
                                    Kutish vaqti
                                </h3>
                                <p style="color: rgba(255,255,255,0.95); margin: 0 0 8px 0; font-size: 17px;">
                                    Oxirgi natija: {{ last_test.percentage }}% (O'tish bali: {{ course.passing_score }}%)
                                </p>
                                <p style="color: rgba(255,255,255,0.85); margin: 0 0 16px 0; font-size: 15px;">
                                    Testni qayta topshirish uchun kutish vaqti:
                                </p>
                                <div id="retryTimer" style="font-size: 48px; font-weight: 700; color: white; font-family: 'Courier New', monospace; margin-bottom: 24px;">
                                    --:--
                                </div>
                                <button disabled class="btn-gradient" style="display: inline-flex; align-items: center; gap: 10px; padding: 16px 40px; background: rgba(255,255,255,0.3); color: white; text-decoration: none; border-radius: 10px; font-weight: 700; font-size: 17px; border: none; cursor: not-allowed; opacity: 0.7;">
                                    <i class="fas fa-lock" style="font-size: 20px;"></i>
                                    <span>Qayta boshlash</span>
                                </button>
                            {% endif %}
                        {% else %}
                            <!-- First time taking test -->
                            <i class="fas fa-trophy" style="font-size: 72px; color: white; margin-bottom: 16px;"></i>
                            <h3 style="color: white; margin: 0 0 12px 0; font-size: 28px; font-weight: 700;">
                                Barcha modullar tugatildi!
                            </h3>
                            <p style="color: rgba(255,255,255,0.95); margin: 0 0 24px 0; font-size: 17px;">
                                Endi yakuniy testni topshirish vaqti. Test o'tish bali: {{ course.passing_score }}%
                            </p>
                            <a href="{% url 'main:course_test' course.id %}" class="btn-gradient" style="display: inline-flex; align-items: center; gap: 10px; padding: 16px 40px; background: white; color: #667eea; text-decoration: none; border-radius: 10px; font-weight: 700; font-size: 17px; box-shadow: 0 6px 20px rgba(0,0,0,0.15);">
                                <i class="fas fa-clipboard-check" style="font-size: 20px;"></i>
                                <span>Testni boshlash</span>
                            </a>
                        {% endif %}
                    </div>
                    {% endif %}
                {% else %}
                <div style="padding: 32px; background: linear-gradient(135deg, #8b5cf6 0%, #d946ef 100%); border-radius: 16px; margin: 24px; text-align: center; box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);">
                    <i class="fas fa-graduation-cap" style="font-size: 64px; color: white; margin-bottom: 16px;"></i>
                    <h3 style="color: white; margin: 0 0 12px 0; font-size: 24px; font-weight: 700;">
                        Barcha modullarni tugating!
                    </h3>
                    <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 16px;">
                        Yakuniy test ochilishi uchun barcha modullarni tugatishingiz kerak
                    </p>
                    <div style="margin-top: 16px; padding: 12px 24px; background: rgba(255,255,255,0.2); border-radius: 8px; display: inline-block;">
                        <span style="color: white; font-weight: 600; font-size: 15px;">
                            <i class="fas fa-lock"></i> Test yopiq
                        </span>
                    </div>
                </div>
                {% endif %}
            {% else %}
                <div style="padding: 48px; text-align: center;">
                    <i class="fas fa-book-open" style="font-size: 48px; color: #9ca3af;"></i>
                    <p class="text-muted" style="margin-top: 16px;">Hozircha modullar mavjud emas</p>
                </div>
            {% endif %}
        </div>
    </div>
</section>

<style>
@media (max-width: 1024px) {
    .module-section > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
    }
    .module-section > div[style*="grid-template-columns"] > div:first-child {
        border-right: none !important;
        border-bottom: 2px solid #e5e7eb;
    }
}

.complete-module-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4) !important;
}

.complete-module-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>

<script>
// Load YouTube IFrame Player API
var tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

var players = {};
var videoTracked = {};

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// This function creates YouTube players after API is ready
function onYouTubeIframeAPIReady() {
    console.log('YouTube API ready');
    document.querySelectorAll('.youtube-video').forEach(iframe => {
        const moduleId = iframe.dataset.moduleId;
        const videoSrc = iframe.src;
        console.log('Processing video for module:', moduleId, 'src:', videoSrc);
        
        if (!videoSrc || videoSrc.indexOf('/embed/') === -1) {
            console.error('Invalid video URL:', videoSrc);
            return;
        }
        
        const videoId = videoSrc.split('/embed/')[1].split('?')[0];
        console.log('Video ID:', videoId);
        
        // Get the container
        const container = iframe.parentNode;
        
        // Create a new div for player
        const playerDiv = document.createElement('div');
        playerDiv.id = 'player-' + moduleId;
        playerDiv.style.position = 'absolute';
        playerDiv.style.top = '0';
        playerDiv.style.left = '0';
        playerDiv.style.width = '100%';
        playerDiv.style.height = '100%';
        
        // Replace iframe with div
        container.replaceChild(playerDiv, iframe);
        
        // Create player
        try {
            players[moduleId] = new YT.Player('player-' + moduleId, {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    'rel': 0,
                    'modestbranding': 1
                },
                events: {
                    'onReady': function(event) {
                        console.log('Player ready for module:', moduleId);
                    },
                    'onStateChange': function(event) {
                        onPlayerStateChange(event, moduleId);
                    },
                    'onError': function(event) {
                        console.error('YouTube player error:', event.data);
                    }
                }
            });
        } catch (error) {
            console.error('Error creating player:', error);
        }
    });
}

function onPlayerStateChange(event, moduleId) {
    // Check if video is playing
    if (event.data == YT.PlayerState.PLAYING && !videoTracked[moduleId]) {
        const player = players[moduleId];
        
        // Check progress every 2 seconds
        const checkInterval = setInterval(() => {
            if (player && player.getCurrentTime && player.getDuration) {
                const currentTime = player.getCurrentTime();
                const duration = player.getDuration();
                const progress = (currentTime / duration) * 100;
                
                console.log('Module ' + moduleId + ' video progress: ' + Math.round(progress) + '%');
                
                // If watched 80% or more, mark as watched
                if (progress >= 80 && !videoTracked[moduleId]) {
                    videoTracked[moduleId] = true;
                    clearInterval(checkInterval);
                    trackVideoWatched(moduleId);
                }
            }
        }, 2000);
    }
    
    // If video ended
    if (event.data == YT.PlayerState.ENDED && !videoTracked[moduleId]) {
        videoTracked[moduleId] = true;
        trackVideoWatched(moduleId);
    }
}

function trackVideoWatched(moduleId) {
    console.log('Tracking video for module:', moduleId);
    
    fetch(`/module/${moduleId}/track-video/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Video track response:', data);
        if (data.status === 'success') {
            console.log('Video tracked successfully for module:', moduleId);
            const statusIcon = document.querySelector(`.video-status-${moduleId}`);
            if (statusIcon) {
                console.log('Updating video status icon');
                statusIcon.classList.remove('fa-circle');
                statusIcon.classList.add('fa-check-circle');
                statusIcon.style.color = '#10b981';
            } else {
                console.error('Video status icon not found for module:', moduleId);
            }
            checkModuleCompletion(moduleId);
        }
    })
    .catch(error => console.error('Error tracking video:', error));
}

document.addEventListener('DOMContentLoaded', function() {
    // Track presentation download
    document.querySelectorAll('.presentation-download').forEach(link => {
        link.addEventListener('click', function(e) {
            const moduleId = this.dataset.moduleId;
            
            console.log('Tracking presentation for module:', moduleId);
            
            // Track presentation view
            fetch(`/module/${moduleId}/track-presentation/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Presentation tracked successfully');
                    // Update UI
                    const statusIcon = document.querySelector(`.presentation-status-${moduleId}`);
                    if (statusIcon) {
                        statusIcon.classList.remove('fa-circle');
                        statusIcon.classList.add('fa-check-circle');
                        statusIcon.style.color = '#10b981';
                    }
                    checkModuleCompletion(moduleId);
                }
            })
            .catch(error => console.error('Error tracking presentation:', error));
        });
    });
    
    // Complete module button
    document.querySelectorAll('.complete-module-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const moduleId = this.dataset.moduleId;
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Yuklanmoqda...</span>';
            
            fetch(`/module/${moduleId}/complete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Show success message
                    this.innerHTML = '<i class="fas fa-check"></i> <span>Tugatildi!</span>';
                    this.style.background = '#10b981';
                    
                    // Reload page after 1 second to show next unlocked module
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('Error completing module:', error);
                this.disabled = false;
                this.innerHTML = "<i class='fas fa-check-double'></i> <span>O'rgandim</span>";
            });
        });
    });
    
    function checkModuleCompletion(moduleId) {
        console.log('=== Checking module completion for:', moduleId, '===');
        
        const videoStatus = document.querySelector(`.video-status-${moduleId}`);
        const presentationStatus = document.querySelector(`.presentation-status-${moduleId}`);
        
        // Try multiple selectors for button
        let completeBtn = document.querySelector(`.complete-btn-container-${moduleId} .complete-module-btn`);
        if (!completeBtn) {
            completeBtn = document.querySelector(`[data-module-id="${moduleId}"].complete-module-btn`);
        }
        
        console.log('Video status element:', videoStatus);
        console.log('Video status classes:', videoStatus ? videoStatus.className : 'NOT FOUND');
        console.log('Presentation status element:', presentationStatus);
        console.log('Presentation status classes:', presentationStatus ? presentationStatus.className : 'NOT FOUND');
        console.log('Complete button element:', completeBtn);
        console.log('Complete button found:', !!completeBtn);
        
        if (!completeBtn) {
            console.error('Complete button not found for module:', moduleId);
            console.log('Trying to find all buttons with class complete-module-btn:', document.querySelectorAll('.complete-module-btn'));
            return;
        }
        
        const videoChecked = videoStatus && videoStatus.classList.contains('fa-check-circle');
        const presentationChecked = presentationStatus && presentationStatus.classList.contains('fa-check-circle');
        
        console.log('Module', moduleId, 'Video checked:', videoChecked, 'Presentation checked:', presentationChecked);
        
        if (videoChecked && presentationChecked) {
            console.log('✅ Both completed! Enabling button...');
            completeBtn.style.opacity = '1';
            completeBtn.style.pointerEvents = 'auto';
            completeBtn.style.cursor = 'pointer';
            completeBtn.disabled = false;
            completeBtn.dataset.videoDone = 'true';
            completeBtn.dataset.presentationDone = 'true';
            console.log('Button enabled! Current styles:', completeBtn.style.cssText);
        } else {
            console.log('❌ Not all tasks completed yet');
            if (!videoChecked) console.log('  - Video not checked');
            if (!presentationChecked) console.log('  - Presentation not checked');
        }
    }
    
    // Retry timer countdown
    {% if not can_retry and wait_seconds > 0 %}
    let remainingSeconds = {{ wait_seconds }};
    const timerElement = document.getElementById('retryTimer');
    
    function updateTimer() {
        const minutes = Math.floor(remainingSeconds / 60);
        const seconds = remainingSeconds % 60;
        timerElement.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        if (remainingSeconds <= 0) {
            // Reload page to enable button
            window.location.reload();
        } else {
            remainingSeconds--;
            setTimeout(updateTimer, 1000);
        }
    }
    
    updateTimer();
    {% endif %}
});
</script>
{% endblock %}
